@model CvProjekt.Models.User

@{
    ViewData["Title"] = "Extern Profil";
    var similar = ViewBag.SimilarProfiles as List<CvProjekt.Models.User> ?? new List<CvProjekt.Models.User>();
}

<div class="container bg-light p-5">
    @if (Model == null)
    {
        <h4>Ingen information hittad</h4>
    }
    else
    {
        <h4 class="text-center" style="margin: 2rem auto;">Profil för @Model.FirstName @Model.LastName</h4>

        <div class="container mb-3 p-5">
            <div class="container mt-3 mb-3 p-5 bg-white shadow-sm d-flex flex-column align-items-center">
                @* Profilbild *@
                @if (!string.IsNullOrWhiteSpace(Model.ImgUrl))
                {
                    <div class="ratio ratio-1x1 rounded-circle overflow-hidden" style="width: 25%; margin: 2rem 1rem;">
                        <img src="@Model.ImgUrl" alt="Profilbild" class="img-fluid object-fit-cover" />
                    </div>
                }

                <div class="container mt-3 mb-3 text-center">
                    <h3 class="mb-3">@Model.FirstName @Model.LastName</h3>
                    <h4>Kontakt:</h4>
                    <h6>@Model.Email</h6>
                    <h6>@Model.Adress</h6>
                </div>

                <div class="container w-100">
                    <h4>Mina kompetenser:</h4>
                    @if (Model.Resume != null && Model.Resume.Qualifications != null && Model.Resume.Qualifications.Any())
                    {
                        <ul class="list-inline">
                            @foreach (var q in Model.Resume.Qualifications)
                            {
                                <li class="list-inline-item border border-info p-1 mb-2">@q.Name</li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted"><em>Inga kompetenser angivna.</em></p>
                    }
                </div>

                <div class="container w-100 mt-3">
                    <h4>Utbildning:</h4>
                    @if (Model.Resume != null && Model.Resume.EducationList != null && Model.Resume.EducationList.Any())
                    {
                        <ul class="list-unstyled">
                            @foreach (var e in Model.Resume.EducationList)
                            {
                                <li class="mb-2">
                                    <strong>@e.SchoolName</strong> - @e.DegreeName
                                    <div class="text-muted">(@e.StartYear - @(e.EndYear != null ? e.EndYear.ToString() : "Nu"))
                                    </div>
                                    @if (!string.IsNullOrWhiteSpace(e.Description))
                                    {
                                        <div>@e.Description</div>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted"><em>Ingen utbildning angiven.</em></p>
                    }
                </div>

                <div class="container w-100 mt-3">
                    <h4>Arbetslivserfarenhet:</h4>
                    @if (Model.Resume != null && Model.Resume.WorkList != null && Model.Resume.WorkList.Any())
                    {
                        <ul class="list-unstyled">
                            @foreach (var w in Model.Resume.WorkList)
                            {
                                <li class="mb-2">
                                    <strong>@w.CompanyName</strong> - @w.Position
                                    <div class="text-muted">(@w.StartDate.ToString("yyyy/MM/dd") - @(w.EndDate != null ?
                                                                    w.EndDate?.ToString("yyyy/MM/dd") : "Nu"))</div>
                                    @if (!string.IsNullOrWhiteSpace(w.Description))
                                    {
                                        <div>@w.Description</div>
                                    }
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <p class="text-muted"><em>Ingen arbetslivserfarenhet angiven.</em></p>
                    }
                </div>

                <div class="d-flex justify-content-center mt-3">
                    <a asp-controller="ExternalProfile" asp-action="DownloadData" asp-route-id="@Model.Id"
                        class="btn btn-outline-secondary me-2">Exportera profil (XML)</a>
                    <a asp-controller="Home" asp-action="Index" class="btn btn-secondary">Tillbaka</a>
                </div>

                @* Kontaktformulär: postar till MessageController.SendMessage *@
                <div class="w-100 mt-4">
                    <h4 class="mb-3 text-center">Kontakta @Model.FirstName</h4>

                    <form asp-controller="Message" asp-action="SendMessage" method="post" class="row g-3">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="ToUserId" value="@Model.Id" />

                        @if (!User.Identity.IsAuthenticated)
                        {
                            <div class="col-md-6">
                                <label for="SenderName" class="form-label">Ditt namn</label>
                                <input type="text" name="SenderName" class="form-control" id="SenderName"
                                    placeholder="Ditt namn" />
                            </div>
                        }

                        <div class="col-12">
                            <label for="Text" class="form-label">Meddelande</label>
                            <textarea name="Text" class="form-control" id="Text" rows="4"
                            placeholder="Skriv ditt meddelande här..." required></textarea>
                        </div>

                        <div class="col-12 text-center">
                            <button type="submit" class="btn btn-primary">Skicka meddelande</button>
                        </div>
                    </form>
                    <small class="text-muted d-block text-center mt-2">Du kan inte se svar här — meddelanden hanteras i din
                        inkorg.</small>
                </div>
            </div>
        </div>

        <div class="container">
            <h4 class="mb-3">Projekt</h4>
            @if (Model.Projects != null && Model.Projects.Any())
            {
                <div class="row">
                    @foreach (var p in Model.Projects)
                    {
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h5 class="card-title">@p.Title (@p.Year)</h5>
                                    <h6 class="card-subtitle mb-2 text-muted">@p.Language</h6>
                                    <p class="card-text">@p.Description</p>
                                    @if (!string.IsNullOrWhiteSpace(p.GithubLink))
                                    {
                                        var link = p.GithubLink.StartsWith("http", System.StringComparison.OrdinalIgnoreCase) ?
                                        p.GithubLink : "https://" + p.GithubLink;
                                        <a href="@link" target="_blank" class="card-link">GitHub</a>
                                    }
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-muted"><em>Inga projekt publicerade.</em></p>
            }
        </div>

        @* Liknande profiler *@
        @if (similar.Any())
        {
            <hr class="my-4" />
            <div class="container">
                <h4 class="mb-3">Liknande profiler</h4>
                <div class="row">
                    @foreach (var s in similar)
                    {
                        <div class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body d-flex">
                                    <div class="me-3" style="width:64px;height:64px;flex-shrink:0;">
                                        @if (!string.IsNullOrWhiteSpace(s.ImgUrl))
                                        {
                                            <img src="@s.ImgUrl" alt="Avatar" class="rounded-circle"
                                                style="width:64px;height:64px;object-fit:cover;" />
                                        }
                                        else
                                        {
                                            <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center"
                                                style="width:64px;height:64px;">
                                                @((s.FirstName ?? "?").Substring(0, 1))@((s.LastName ?? "?").Substring(0, 1))
                                            </div>
                                        }
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">@s.FirstName @s.LastName</h6>
                                        <p class="small text-muted mb-1">
                                            @if (s.Resume?.Qualifications != null && s.Resume.Qualifications.Any())
                                            {
                                                @string.Join(", ", s.Resume.Qualifications.Select(q => q.Name).Take(5))
                                            }
                                            else
                                            {
                                                <em>Inga kompetenser listade</em>
                                            }
                                        </p>
                                        <a asp-controller="ExternalProfile" asp-action="Profile" asp-route-id="@s.Id"
                                            class="btn btn-sm btn-outline-primary">Visa profil</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }
    }
</div>