@using System.Security.Claims
@model CvProjekt.Models.HomeViewModel


<div class="container py-4" id="AllProjectsBox">
    <div class="row justify-content-center">
        @if (TempData["SuccessMessage"] != null)
        {
            <div class="alert alert-success text-center mx-5 mt-3">
                @TempData["SuccessMessage"]
            </div>
        }
        @if (TempData["Info"] != null)
        {
            <div class="alert alert-danger text-center mx-5 mt-3">
                @TempData["Info"]
            </div>
        }
        <div class="col-lg-10">
            @foreach (var project in Model.AllProjects)
            {
                // allt detta är kontroller för att se om man är skapare, medlem, eller inte. Var lättare att göra här än att
                //göra i controllern.
                var currentUserId = User.Identity?.IsAuthenticated == true
                ? User.FindFirstValue(ClaimTypes.NameIdentifier)
                : null;

                var isCreator = currentUserId != null && project.CreatorId == currentUserId;
                var isMember = currentUserId != null && Model.ProjectMemberList
                .Any(pm => pm.MemberId == currentUserId && pm.MProjectId == project.Id);
                var members = Model.ProjectMemberList
                .Where(pm => pm.MProjectId == project.Id)
                .Select(pm => pm.user)
                .Where(u => u != null && u.Id != project.CreatorId && u.IsActive == true)
                .Distinct()
                .ToList();

                <div class="card mb-4 shadow-sm border-0 bg-light">
                    <div asp-validation-summary="All" class="text-danger"></div>
                    <div class="row g-0">
                        <div class="col-1 bg-primary rounded-start d-none d-md-block" style="width: 6px;"></div>
                        <div class="col">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h3 class="h4 mb-0 fw-bold text-dark">@project.Title</h3>
                                    <span class="badge rounded-pill bg-white text-primary border border-primary px-3">
                                        @project.Year
                                    </span>
                                </div>

                                <div class="mb-3">
                                    <h6 class="text-uppercase text-muted fw-bold small mb-2">Beskrivning</h6>
                                    <p class="card-text lh-lg text-secondary" style="font-size: 1.1rem;">
                                        @project.Description
                                    </p>
                                </div>

                                <div class="d-flex align-items-center justify-content-between mt-4 pt-3 border-top">
                                    <div>
                                        <span class="text-muted small">SPRÅK:</span>
                                        <span class="ms-2 fw-semibold">@project.Language</span>
                                    </div>

                                    @if (project.Creator != null)
                                    {
                                        if (!User.Identity?.IsAuthenticated == true && project.Creator.IsPrivate)
                                        {
                                            <div class="text-muted small">Av: Privat användare</div>
                                        }
                                        else
                                        {
                                            <div class="d-flex align-items-center">
                                                <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                                    style="width: 32px; height: 32px; font-size: 0.8rem;">
                                                    @(project.Creator.FirstName[0])@(project.Creator.LastName[0])
                                                </div>
                                                <span class="text-muted small">
                                                    Skapat av
                                                    <span class="fw-bold text-dark">@project.Creator.FirstName
                                                        @project.Creator.LastName</span>
                                                </span>
                                            </div>
                                        }
                                    }
                                </div>

                                @if (members.Any())
                                {
                                    <div class="mt-3">
                                        <h6 class="small text-muted mb-2">Medlemmar</h6>
                                        <div class="d-flex flex-wrap align-items-center">
                                            @foreach (var member in members)
                                            {
                                                if (member.Id != project.CreatorId)
                                                {
                                                    if (!User.Identity?.IsAuthenticated == true && member.IsPrivate)
                                                    {
                                                        <div class="me-3 mb-2 small text-muted">Privat användare</div>
                                                    }
                                                    else
                                                    {
                                                        <div class="d-flex align-items-center me-3 mb-2">
                                                            <div class="bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
                                                                style="width: 28px; height: 28px; font-size: 0.8rem;">
                                                                @(member.FirstName?[0] ?? '?')@(member.LastName?[0] ?? '?')
                                                            </div>
                                                            <span class="small text-dark">@member.FirstName @member.LastName</span>
                                                        </div>
                                                    }
                                                }
                                            }
                                        </div>
                                    </div>
                                }
                                else
                                {
                                    <h6 class="small text-muted mb-2"> </h6>
                                }

                                <div class="mt-3">
                                    @if (!User.Identity.IsAuthenticated)
                                    {
                                        <a class="btn btn-primary" href="~/Identity/Account/Login">Logga in för att gå med</a>
                                    }
                                    else if (isCreator)
                                    {
                                        <span class="badge bg-secondary">Du skapade projektet</span>
                                    }
                                    else if (isMember)
                                    {
                                        <form asp-action="LeaveProject" method="post" class="d-inline">
                                            <input type="hidden" name="projectId" value="@project.Id" />
                                            <button type="submit" class="btn btn-outline-danger">Lämna projekt</button>
                                        </form>
                                    }
                                    else
                                    {
                                        <form asp-action="JoinProject" method="post" class="d-inline"
                                            asp-route-source="AllProjects">
                                            <input type="hidden" name="projectId" value="@project.Id" />
                                            <button type="submit" class="btn btn-primary">Gå med i projekt</button>
                                        </form>
                                    }
                                </div>


                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>
</div>